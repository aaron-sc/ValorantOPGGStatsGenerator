<!DOCTYPE html>
<html lang="en" data-theme="valo">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Valorant Scout{% endblock %}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;600;700&family=Teko:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header class="site-header">
  <div class="header-inner">
    <div class="brand">VALORANT SCOUT</div>
    <div class="nav-actions">
      <div class="row wrap" style="gap:8px;">
        <span class="badge">Theme</span>
        <select id="themeSelect" aria-label="Theme">
          <option value="valo">Valo</option>
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </div>
      <button class="btn secondary" id="tutorialReplayHeader">Tutorial</button>
      <button class="btn secondary" onclick="history.back()">&larr; Back</button>
      <a href="/" class="btn secondary">Home</a>
    </div>
  </div>
</header>

<main class="container">
  {% block content %}{% endblock %}
</main>

<footer class="site-footer">
</footer>

<!-- Floating actions -->
<button class="floating-btn" id="toTop" title="Back to top" aria-label="Back to top">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M12 5l6 6-1.4 1.4L13 9.8V19h-2V9.8L7.4 12.4 6 11z"></path>
  </svg>
</button>

<!-- Toast -->
<div class="toast" id="toast" aria-live="polite"></div>

<!-- Progress Overlay -->
<div class="progress-overlay" id="progressOverlay">
  <div class="progress-card">
    <div class="progress-title">Scraping OP.GG...</div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="subtle" style="margin-top:10px;" id="progressText">
      Initializing...
    </div>
  </div>
</div>

<!-- First-run tutorial -->
<div class="modal-overlay" id="tutorialOverlay" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="tutorialTitle">
    <div class="card-title">
      <h2 class="h2" id="tutorialTitle">Welcome to Valorant Scout</h2>
      <span class="pill pill-mid">Interactive Tutorial</span>
    </div>
    <div class="subtle" style="margin-top:8px;">
      Follow the steps to learn the full workflow. You can replay this anytime.
    </div>

    <div class="tutorial-progress" id="tutorialProgress"></div>

    <div class="tutorial-step">
      <div class="tutorial-step-count" id="tutorialStepCount">Step 1 of 1</div>
      <div class="tutorial-step-title" id="tutorialStepTitle">Step</div>
      <div class="tutorial-step-body" id="tutorialStepBody"></div>
    </div>

    <div class="row" style="margin-top:16px; gap:10px; justify-content:space-between;">
      <div class="row" style="gap:10px;">
        <button class="btn ghost" id="tutorialBack">Back</button>
        <button class="btn success" id="tutorialNext">Next</button>
      </div>
      <div class="row" style="gap:10px;">
        <button class="btn secondary" id="tutorialReplay">Replay</button>
        <button class="btn ghost" id="tutorialSkip">Skip</button>
      </div>
    </div>
  </div>
</div>

<script>
function showProgress() {
  document.getElementById("progressOverlay").style.display = "flex";
}

function updateProgress(pct, text) {
  document.getElementById("progressFill").style.width = pct + "%";
  if (text) document.getElementById("progressText").innerText = text;
}

function hideProgress() {
  document.getElementById("progressOverlay").style.display = "none";
}

function showToast(msg) {
  const el = document.getElementById("toast");
  if (!el) return;
  el.textContent = msg;
  el.classList.add("show");
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(() => el.classList.remove("show"), 1600);
}

function applyTheme(theme) {
  document.documentElement.setAttribute("data-theme", theme);
}

const themeSelect = document.getElementById("themeSelect");
const THEME_KEY = "valo_theme";
const savedTheme = localStorage.getItem(THEME_KEY) || "valo";
applyTheme(savedTheme);
if (themeSelect) {
  themeSelect.value = savedTheme;
  themeSelect.addEventListener("change", (e) => {
    const t = e.target.value || "valo";
    applyTheme(t);
    localStorage.setItem(THEME_KEY, t);
    showToast(`Theme: ${t}`);
  });
}

function _parseSortableValue(text) {
  if (text === null || text === undefined) return { num: NaN, text: "" };
  let t = String(text).replace(/\u2014|\u2013/g, "").trim();
  if (!t) return { num: NaN, text: "" };

  // Handle time like "7h 6m"
  const hm = t.match(/(\d+)\s*h\s*(\d+)?\s*m?/i);
  if (hm) {
    const hours = parseInt(hm[1], 10) || 0;
    const mins = parseInt(hm[2] || "0", 10) || 0;
    return { num: hours * 60 + mins, text: t.toLowerCase() };
  }

  // Handle ratios like "1.54:1"
  if (t.includes(":")) {
    const left = t.split(":")[0];
    const ratioNum = parseFloat(left.replace(/[^0-9.\-]/g, ""));
    if (!Number.isNaN(ratioNum)) return { num: ratioNum, text: t.toLowerCase() };
  }

  const m = t.replace(/,/g, "").match(/-?\d+(\.\d+)?/);
  if (m) return { num: parseFloat(m[0]), text: t.toLowerCase() };
  return { num: NaN, text: t.toLowerCase() };
}

function _getCellSortValue(cell) {
  if (!cell) return { num: NaN, text: "" };
  const override = cell.getAttribute("data-sort-value");
  if (override !== null) return _parseSortableValue(override);
  return _parseSortableValue(cell.textContent);
}

function makeTablesSortable() {
  document.querySelectorAll("table").forEach((table) => {
    const thead = table.tHead;
    const tbody = table.tBodies && table.tBodies[0];
    if (!thead || !tbody) return;

    const headers = Array.from(thead.querySelectorAll("th"));
    if (!headers.length) return;

    headers.forEach((th, idx) => {
      th.classList.add("sortable");
      th.addEventListener("click", () => {
        const dir = th.dataset.sortDir === "asc" ? "desc" : "asc";
        headers.forEach((h) => {
          if (h !== th) {
            h.dataset.sortDir = "";
            h.classList.remove("sorted-asc", "sorted-desc");
          }
        });
        th.dataset.sortDir = dir;
        th.classList.toggle("sorted-asc", dir === "asc");
        th.classList.toggle("sorted-desc", dir === "desc");

        const rows = Array.from(tbody.rows).map((row, i) => ({ row, i }));
        rows.sort((a, b) => {
          const aCell = a.row.cells[idx];
          const bCell = b.row.cells[idx];
          const av = _getCellSortValue(aCell);
          const bv = _getCellSortValue(bCell);

          const aNum = av.num;
          const bNum = bv.num;
          const aNumOk = !Number.isNaN(aNum);
          const bNumOk = !Number.isNaN(bNum);

          if (aNumOk && bNumOk) {
            if (aNum === bNum) return a.i - b.i;
            return dir === "asc" ? aNum - bNum : bNum - aNum;
          }
          if (aNumOk !== bNumOk) {
            return dir === "asc"
              ? (aNumOk ? -1 : 1)
              : (aNumOk ? 1 : -1);
          }

          const cmp = av.text.localeCompare(bv.text);
          return cmp === 0 ? a.i - b.i : (dir === "asc" ? cmp : -cmp);
        });

        rows.forEach(({ row }) => tbody.appendChild(row));
      });
    });
  });
}

document.addEventListener("DOMContentLoaded", makeTablesSortable);

// First-run tutorial modal
document.addEventListener("DOMContentLoaded", () => {
  const KEY = "valo_tutorial_seen";
  const overlay = document.getElementById("tutorialOverlay");
  const stepTitle = document.getElementById("tutorialStepTitle");
  const stepBody = document.getElementById("tutorialStepBody");
  const stepCount = document.getElementById("tutorialStepCount");
  const progress = document.getElementById("tutorialProgress");
  const backBtn = document.getElementById("tutorialBack");
  const nextBtn = document.getElementById("tutorialNext");
  const skipBtn = document.getElementById("tutorialSkip");
  const replayBtn = document.getElementById("tutorialReplay");
  const headerReplay = document.getElementById("tutorialReplayHeader");

  if (!overlay || !stepTitle || !stepBody || !stepCount || !progress || !backBtn || !nextBtn || !skipBtn || !replayBtn) {
    return;
  }

  const steps = [
    {
      title: "Get a Team List Ready",
      body: `
        <div class="tutorial-lead">Create a simple text file with the team name on line 1, then Riot IDs below.</div>
        <div class="tutorial-example">
          <div class="tutorial-example-title">Example Team File</div>
          <pre class="tutorial-code">Nova Esports
PlayerOne#NA1
SecondEntry#EUW
Fragger#123
IGLName#777</pre>
        </div>
        <div class="tutorial-note">Tip: Use one Riot ID per line. Extra spaces are okay.</div>
      `,
    },
    {
      title: "Upload and Scrape",
      body: `
        <div class="tutorial-lead">On the home page, upload the team file and choose a season.</div>
        <div class="tutorial-callout">
          Click <span class="kbd">Start Scrape</span> to build the dashboard.
        </div>
        <div class="tutorial-note">Scraping can take a minute depending on roster size.</div>
      `,
    },
    {
      title: "Use Map Filters",
      body: `
        <div class="tutorial-lead">On the team dashboard, control which maps influence the stats.</div>
        <div class="tutorial-list">
          <div>Click <span class="kbd">Map Filters</span> to enable or disable maps.</div>
        </div>
        <div class="tutorial-note">The current competitive pool is pre-selected by default.</div>
      `,
    },
    {
      title: "Read the Pick/Ban Planner",
      body: `
        <div class="tutorial-lead">The pick list is what you should look to pick first. The ban list is what you should look to ban first.</div>
        <div class="tutorial-callout">
          These suggestions follow your current queue and map filters.
        </div>
      `,
    },
    {
      title: "Review Map and Agent Insights",
      body: `
        <div class="tutorial-lead">Check map win rates, volatility, and top agents to understand tendencies.</div>
        <div class="tutorial-note">Open individual player pages for deeper agent and map details.</div>
      `,
    },
    {
      title: "Compare Two Teams",
      body: `
        <div class="tutorial-lead">Use <span class="kbd">Compare Teams</span> from the home page.</div>
        <div class="tutorial-note">You can use Map Filters on the comparison view too.</div>
      `,
    },
    {
      title: "Share Results",
      body: `
        <div class="tutorial-lead">Export a full-page snapshot or download raw data.</div>
        <div class="tutorial-list">
          <div><span class="kbd">Export Snapshot (.png)</span> for sharing in chat</div>
          <div><span class="kbd">Download .json</span> or <span class="kbd">Export Dashboard (.zip)</span> for archive</div>
        </div>
      `,
    },
  ];

  let step = 0;

  const renderProgress = () => {
    progress.innerHTML = "";
    steps.forEach((_, i) => {
      const dot = document.createElement("span");
      dot.className = "tutorial-dot" + (i === step ? " active" : "");
      progress.appendChild(dot);
    });
  };

  const renderStep = () => {
    const s = steps[step];
    stepTitle.textContent = s.title;
    stepBody.innerHTML = s.body;
    stepCount.textContent = `Step ${step + 1} of ${steps.length}`;
    backBtn.disabled = step === 0;
    nextBtn.textContent = step === steps.length - 1 ? "Finish" : "Next";
    renderProgress();
  };

  const openTutorial = (force = false) => {
    if (!force && localStorage.getItem(KEY)) return;
    overlay.style.display = "flex";
    overlay.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");
    step = 0;
    renderStep();
  };

  const closeTutorial = () => {
    localStorage.setItem(KEY, "1");
    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");
  };

  nextBtn.addEventListener("click", () => {
    if (step < steps.length - 1) {
      step += 1;
      renderStep();
    } else {
      closeTutorial();
    }
  });

  backBtn.addEventListener("click", () => {
    if (step > 0) {
      step -= 1;
      renderStep();
    }
  });

  replayBtn.addEventListener("click", () => {
    step = 0;
    renderStep();
  });

  skipBtn.addEventListener("click", closeTutorial);

  if (headerReplay) {
    headerReplay.addEventListener("click", () => openTutorial(true));
  }

  openTutorial(false);
});

// Floating "back to top"
const toTop = document.getElementById("toTop");
if (toTop) {
  const toggleToTop = () => {
    if (window.scrollY > 240) toTop.classList.add("show");
    else toTop.classList.remove("show");
  };
  window.addEventListener("scroll", toggleToTop, { passive: true });
  toggleToTop();
  toTop.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
}
</script>

{% block scripts %}{% endblock %}
</body>
</html>
